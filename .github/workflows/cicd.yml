on: [push, workflow_dispatch]

jobs:
  lint:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Linting
        uses: internetarchive/dyno/.github/workflows/lint.yml@main

  test:
    runs-on: self-hosted
    container:
      image: ghcr.io/internetarchive/dyno:main
    steps:
      - uses: actions/checkout@v4
      - name: Run Test Script
        run: |
          echo "Listing directory contents for debugging:"
          ls -la
          echo "Executing test script:"
          bash test/test.sh

  cicd:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: CICD Job
        uses: internetarchive/cicd/.github/workflows/cicd.yml@main
        with:
          BASE_DOMAIN: 'starnix.net'
          NOMAD_ADDR: 'http://nn.starnix.net:4646'
        secrets:
          NOMAD_TOKEN: ${{ secrets.NOMAD_TOKEN }}
    needs: [lint, test]

  image-test:
    runs-on: self-hosted
    container:
      image: 'docker://ghcr.io/${{ github.repository }}:${{ github.ref_name }}'
    needs: [cicd]
    steps:
      - name: Run Image Test
        run: fgrep 'hello js' /app/index.js
